<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="favicon.png" rel="icon">
	<meta name="robots" content="noindex, nofollow" />
	<meta name="googlebot" content="noindex">

	<title>000 QR Scanner</title>
	<meta name="description" content="QR Code Scanner is the fastest and most user-friendly web application.">

	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			padding: 20px;
			background: #fafafa;
		}

		video {
			width: 100%;
			max-width: 420px;
			border: 2px solid #ccc;
			border-radius: 8px;
		}

		#result {
			margin-top: 12px;
			font-weight: bold;
		}

		#status {
			margin-top: 12px;
			padding: 12px;
			border-radius: 6px;
			font-weight: bold;
			text-align: center;
		}

		.success {
			background: #d4edda;
			color: #155724;
		}

		.used {
			background: #fff3cd;
			color: #856404;
		}

		.error {
			background: #f8d7da;
			color: #721c24;
		}

		button {
			margin-top: 16px;
			padding: 10px 18px;
			font-size: 16px;
			cursor: pointer;
		}
	</style>
</head>

<body>

	<h2>Scan QR Code</h2>

	<video id="video"></video>

	<div id="result">Arahkan kamera ke QR Code</div>
	<p id="status">Siap untuk Scanning</p>

	<button id="resetBtn" style="display:none;">Scan Lagi</button>

	<hr style="margin-top: 50px;">
	<p style="text-align: center;">v.1.6</p>

	<script type="module">
		import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";

		QrScanner.WORKER_PATH =	"https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";

		const video = document.getElementById("video");
		const resultEl = document.getElementById("result");
		const statusEl = document.getElementById("status");
		const resetBtn = document.getElementById("resetBtn");

		let scanner;
		let isScanning = false;

		// üî¥ GANTI DENGAN URL GAS ANDA
		const GAS_URL = "https://script.google.com/macros/s/AKfycbzRfh9W7GCC0hXzWdZIgkVKvYDyaynF9euaXc9HUskXcUDvt9BFlcR7wJHF7ZVAdPVW/exec";

		function startScanner() {
			statusEl.innerHTML = "<span style='font-weight:normal;'>- Siap untuk Scanning -</span>";
			statusEl.className = "";
			resultEl.innerText = "Arahkan kamera ke QR Code";
			resetBtn.style.display = "none";

			scanner = new QrScanner(
				video,
				onScanSuccess,
				{
					preferredCamera: "environment",
					highlightScanRegion: true,
					highlightCodeOutline: true
				}
			);

			scanner.start()
				.then(() => {
					console.log("Scanner started");
					isScanning = true;
				})
				.catch(err => {
					console.error("Camera error:", err);
					statusEl.className = "error";
					statusEl.innerText = "‚ùå Kamera tidak dapat diakses";
				});
		}

		async function stopScanner() {
			if (scanner && isScanning) {
				await scanner.stop();
				scanner.destroy();
				isScanning = false;
				console.log("Scanner stopped");
			}
		}

		async function onScanSuccess(result) {
			if (!isScanning) return;

			console.log("SCAN RESULT:", result.data);
			resultEl.innerText = "QR: " + result.data;

			await stopScanner(); // ‚õî STOP KAMERA SETELAH SCAN
			statusEl.innerHTML = "<img height='30px' src='assets/image/loading.webp'>";

			try {
				const response = await fetch(GAS_URL, {
					method: "POST",
					body: JSON.stringify({ code: result.data })
				});

				const data = await response.json();
				console.log("GAS RESPONSE:", data);

				if (data.status === "success") {
					statusEl.className = "success";
					statusEl.innerText = `‚úÖ Berhasil ‚Äî ${data.nama}`;
				} else if (data.status === "used") {
					statusEl.className = "used";
					statusEl.innerText = `‚ö†Ô∏è Sudah dipakai ‚Äî ${data.nama}`;
				} else if (data.status === "not_found") {
					statusEl.className = "error";
					statusEl.innerText = "‚ùå QR Code tidak terdaftar";
				} else {
					statusEl.className = "error";
					statusEl.innerText = "‚ùå Terjadi kesalahan";
				}

				resetBtn.style.display = "inline-block";

			} catch (err) {
				console.error("FETCH ERROR:", err);
				statusEl.className = "error";
				statusEl.innerText = "‚ùå Gagal koneksi ke server";
				resetBtn.style.display = "inline-block";
			}
		}

		resetBtn.addEventListener("click", async () => {
			await stopScanner();
			startScanner();
		});

		// Start pertama kali
		startScanner();
	</script>

</body>
</html>
